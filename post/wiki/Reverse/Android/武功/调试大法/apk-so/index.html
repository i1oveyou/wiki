<!doctype html>
<html >
<head>
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <!--[if lt IE 9]>
                <script src="http://css3-mediaqueries-js.googlecode.com/svn/trunk/css3-mediaqueries.js"></script>
        <![endif]-->
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta http-equiv="Content-Style-Type" content="text/css" />

    <!-- <link rel="stylesheet" type="text/css" href="template.css" /> -->
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/diversen/pandoc-bootstrap-adaptive-template@959c3622/template.css" />

    <link href="https://vjs.zencdn.net/5.4.4/video-js.css" rel="stylesheet" />

    <script src="https://code.jquery.com/jquery-2.2.1.min.js"></script>
    <!-- <script type='text/javascript' src='menu/js/jquery.cookie.js'></script> -->
    <!-- <script type='text/javascript' src='menu/js/jquery.hoverIntent.minified.js'></script> -->
    <!-- <script type='text/javascript' src='menu/js/jquery.dcjqaccordion.2.7.min.js'></script> -->

    <!-- <link href="menu/css/skins/blue.css" rel="stylesheet" type="text/css" /> -->
    <!-- <link href="menu/css/skins/graphite.css" rel="stylesheet" type="text/css" /> -->
    <!-- <link href="menu/css/skins/grey.css" rel="stylesheet" type="text/css" /> -->
  
    <!-- <script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script> -->
        
  
    <!-- <script src="script.js"></script> -->
  
    <!-- <script src="jquery.sticky-kit.js "></script> -->
    <script type='text/javascript' src='https://cdn.jsdelivr.net/gh/diversen/pandoc-bootstrap-adaptive-template@959c3622/menu/js/jquery.cookie.js'></script>
    <script type='text/javascript' src='https://cdn.jsdelivr.net/gh/diversen/pandoc-bootstrap-adaptive-template@959c3622/menu/js/jquery.hoverIntent.minified.js'></script>
    <script type='text/javascript' src='https://cdn.jsdelivr.net/gh/diversen/pandoc-bootstrap-adaptive-template@959c3622/menu/js/jquery.dcjqaccordion.2.7.min.js'></script>

    <link href="https://cdn.jsdelivr.net/gh/diversen/pandoc-bootstrap-adaptive-template@959c3622/menu/css/skins/blue.css" rel="stylesheet" type="text/css" />
    <link href="https://cdn.jsdelivr.net/gh/diversen/pandoc-bootstrap-adaptive-template@959c3622/menu/css/skins/graphite.css" rel="stylesheet" type="text/css" />
    <link href="https://cdn.jsdelivr.net/gh/diversen/pandoc-bootstrap-adaptive-template@959c3622/menu/css/skins/grey.css" rel="stylesheet" type="text/css" />
  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
  
    <script src="https://cdn.jsdelivr.net/gh/diversen/pandoc-bootstrap-adaptive-template@959c3622/script.js"></script>
  
    <script src="https://cdn.jsdelivr.net/gh/diversen/pandoc-bootstrap-adaptive-template@959c3622/jquery.sticky-kit.js"></script>
    <meta name="generator" content="pandoc" />
  <title>wiki-Reverse-Android-武功-调试大法-apk-so</title>
  <style type="text/css">code{white-space: pre;}</style>
</head>
<body>

    
    <div class="navbar navbar-static-top">
    <div class="navbar-inner">
      <div class="container">
        <span class="doc-title">wiki-Reverse-Android-武功-调试大法-apk-so</span>
        <ul class="nav pull-right doc-info">
                            </ul>
      </div>
    </div>
  </div>
    <div class="container">
    <div class="row">
            <div id="TOC" class="span3">
        <div class="well toc">

        <ul>
        <li><a href="#环境" id="toc-环境">环境</a></li>
        <li><a href="#准备工作" id="toc-准备工作">准备工作</a></li>
        <li><a href="#自动加载" id="toc-自动加载">自动加载</a>
        <ul>
        <li><a href="#可能遇到的问题"
        id="toc-可能遇到的问题">可能遇到的问题</a></li>
        <li><a href="#情况1-ida卡死" id="toc-情况1-ida卡死">情况1
        IDA卡死</a></li>
        <li><a href="#情况2" id="toc-情况2">情况2</a></li>
        <li><a href="#情况3" id="toc-情况3">情况3</a></li>
        </ul></li>
        <li><a href="#触发加载" id="toc-触发加载">触发加载</a></li>
        </ul>

        </div>
      </div>
            <div class="span9">

      
      <h1 id="环境">环境</h1>
<p>root的oppo r15x</p>
<p>IDA 7.5</p>
<p>链接：https://pan.baidu.com/s/14J5AXLbw6XjY4GF8UYQU7A?pwd=wnom</p>
<p>提取码：wnom</p>
<p>apk程序的包名叫 com.example.myapplication_002</p>
<p>apk的安装</p>
<pre><code>C:\xxxx\code\file&gt;adb install -t loadso-middle.apk
Performing Streamed Install
Success</code></pre>
<h1 id="准备工作">准备工作</h1>
<p>解包apk，提取出so文件，逆向分析apk，IDA逆向分析so</p>
<p>如果不简单看看apk内容是干嘛的，您可能不太看得懂我下面的一些内容。</p>
<h1 id="自动加载">自动加载</h1>
<p>也就是程序启动的时候就加载so了，而不是等用户去触发。</p>
<p>以load-start.apk为例。</p>
<p>我们定位字符串 <code>Hello from C++</code></p>
<p>大概在引用字符串<code>Hello from C++</code>下断点</p>
<figure>
<img src="./img/image-20240617160540710.png"
alt="image-20240617160540710" />
<figcaption aria-hidden="true">image-20240617160540710</figcaption>
</figure>
<p>也就是我们在Base+0x24324的地方下断点</p>
<p>接下来准备调试so</p>
<p>1），root模式启动android_server64</p>
<pre><code>PBCM10:/data/local/tmp/dbg # ./android_server64
IDA Android 64-bit remote debug server(ST) v7.7.27. Hex-Rays (c) 2004-2022
Listening on 0.0.0.0:23946...</code></pre>
<p>2），adb端口转发</p>
<pre><code>C:\Users\xxxx&gt;adb forward tcp:23946 tcp:23946
23946</code></pre>
<p>3），debug模式启动手机上的目标apk，（如果没安装就安装）</p>
<pre><code>adb shell am start -D -n com.example.myapplication_002/com.example.myapplication_002.MainActivity</code></pre>
<p>4），新开一个空白的IDA，附加我们的apk进程</p>
<figure>
<img src="./img/image-20240617160831112.png"
alt="image-20240617160831112" />
<figcaption aria-hidden="true">image-20240617160831112</figcaption>
</figure>
<p>然后输入ip</p>
<figure>
<img src="./img/image-20240617160847095.png"
alt="image-20240617160847095" />
<figcaption aria-hidden="true">image-20240617160847095</figcaption>
</figure>
<p>然后在列表中找到我们的进程，然后双击它。找不到就search</p>
<p>ps：如果不是root模式启动android_server64，就看不到这么多进程</p>
<figure>
<img src="./img/image-20240617160907793.png"
alt="image-20240617160907793" />
<figcaption aria-hidden="true">image-20240617160907793</figcaption>
</figure>
<p>附加成功之后，进入IDA界面，这时IDA会分析1-2秒钟，然后我们再F9。</p>
<figure>
<img src="./img/image-20240617160925740.png"
alt="image-20240617160925740" />
<figcaption aria-hidden="true">image-20240617160925740</figcaption>
</figure>
<p>5），然后打开ddms，或者叫做AppData.bat</p>
<p>这工具需要在JDK8下运行。</p>
<figure>
<img src="./img/image-20240617160945724.png"
alt="image-20240617160945724" />
<figcaption aria-hidden="true">image-20240617160945724</figcaption>
</figure>
<p>正常情况下，你没开Android Studio ，或者你关闭了Android
Studio，或者其它之类的情况</p>
<p>图中会显示一个红色的虫子（必须是这个红色的虫子），然后最右边会显示一个端口号8600,或者其它端口8700……</p>
<p>接下来是3种不成熟的情况，麻烦依次看完</p>
<h2 id="可能遇到的问题">可能遇到的问题</h2>
<h4 id="异常报错很频繁">异常报错很频繁</h4>
<blockquote>
<p>way1</p>
</blockquote>
<p>在 \7.7.cfg中，屏蔽一些常见的异常报错</p>
<p>方法是 把stop变为nostop</p>
<pre><code>; Linux exceptions
.linux
1    stop mask warn SIGHUP    Hangup
2    stop mask warn SIGINT    Interrupt
3    stop mask warn SIGQUIT   Quit
4    nostop mask warn SIGILL    Illegal instruction
5    nostop mask warn SIGTRAP   Trace trap
6    nostop mask warn SIGABRT   Abort
7    stop mask warn SIGBUS    BUS error
8    stop mask warn SIGFPE    Floating-point exception</code></pre>
<blockquote>
<p>way2</p>
</blockquote>
<figure>
<img src="./img/image-20240617161110000.png"
alt="image-20240617161110000" />
<figcaption aria-hidden="true">image-20240617161110000</figcaption>
</figure>
<p>选择change exception definition，然后定义</p>
<p>这种方法和way-1不同的是，way2是临时的，way1是永久的。</p>
<p>way1的异常是有限的，way2的异常可以是没定义的new exception</p>
<h2 id="情况1-ida卡死">情况1 IDA卡死</h2>
<p>6），根据自己需要去设置一些条件断点，本案例的情况1，不需要去设置</p>
<figure>
<img src="./img/image-20240617161200558.png"
alt="image-20240617161200558" />
<figcaption aria-hidden="true">image-20240617161200558</figcaption>
</figure>
<p>然后, 输入 jdb -connect相关指令</p>
<p>涉及指令中的端口来自ddms，其它不需要修改</p>
<pre><code>C:\Users\tinyx&gt;jdb -connect com.sun.jdi.SocketAttach:hostname=127.0.0.1,port=8600
设置未捕获的java.lang.Throwable
设置延迟的未捕获的java.lang.Throwable
正在初始化jdb...
&gt;</code></pre>
<p>然后IDA正常运转。我们寻找so的模块，去目标的地址下断点</p>
<p>右键模块，jump to module base。</p>
<p>然后IDA卡死…本情况结束</p>
<figure>
<img src="./img/image-20240617161223268.png"
alt="image-20240617161223268" />
<figcaption aria-hidden="true">image-20240617161223268</figcaption>
</figure>
<p>如果你选择 Analyza module，但他会分析得很慢很慢，超级慢。</p>
<p>只能被迫取消 Analyza module，取消后再jump to module base。</p>
<p>当时我发现可以jump过去，但是jump过去后又卡死了。</p>
<h2 id="情况2">情况2</h2>
<p>在情况1基础上</p>
<figure>
<img src="./img/image-20240617161311374.png"
alt="image-20240617161311374" />
<figcaption aria-hidden="true">image-20240617161311374</figcaption>
</figure>
<p>可以发现base=0x7c86680000</p>
<p>然后我们去base+0x24324的地方下断点。</p>
<p>这里我们不是jump to modue base</p>
<p>而是按键 g，然后输入0x7c86680000+0x24324</p>
<p>然后在对应地方C一下，并在那里下断点breakpoint F2</p>
<figure>
<img src="./img/image-20240617161330450.png"
alt="image-20240617161330450" />
<figcaption aria-hidden="true">image-20240617161330450</figcaption>
</figure>
<p>然后我们点击按钮，就可以看见IDA断下来了</p>
<figure>
<img src="./img/image-20240617161350422.png"
alt="image-20240617161350422" />
<figcaption aria-hidden="true">image-20240617161350422</figcaption>
</figure>
<h2 id="情况3">情况3</h2>
<p>在IDA attach后，分析完毕，然后F9。</p>
<p>此刻我们设置条件断点, 也就是 <code>步骤5）</code></p>
<figure>
<img src="./img/image-20240617161420707.png"
alt="image-20240617161420707" />
<figcaption aria-hidden="true">image-20240617161420707</figcaption>
</figure>
<p>然后输入下面这条指令</p>
<pre><code>jdb -connect com.sun.jdi.SocketAttach:hostname=127.0.0.1,port=8600</code></pre>
<p>结果如下</p>
<pre><code>C:\Users\xxxx&gt;jdb -connect com.sun.jdi.SocketAttach:hostname=127.0.0.1,port=8600
设置未捕获的java.lang.Throwable
设置延迟的未捕获的java.lang.Throwable
正在初始化jdb...
&gt;</code></pre>
<p>然后IDA就会停下来，我们一步一步F9，加载模块</p>
<pre><code>The initial autoanalysis has been finished.
7CE8A05000: loaded /apex/com.android.runtime/lib64/libopenjdkjvmti.so
7CE8993000: loaded /apex/com.android.runtime/lib64/libart-dexlayout.so
7CE8920000: loaded /apex/com.android.runtime/lib64/libjdwp.so
7CE88DA000: loaded /apex/com.android.runtime/lib64/libnpt.so
7CE43D1000: loaded /apex/com.android.runtime/lib64/libdt_fd_forward.so
7C8648C000: loaded /data/app/com.example.myapplication_002-NOSIdxadOZbrBaHYt4g3mQ==/lib/arm64/libmyapplication_002.so</code></pre>
<p>当加载到目标模块时，jump to module base</p>
<figure>
<img src="./img/image-20240617161502305.png"
alt="image-20240617161502305" />
<figcaption aria-hidden="true">image-20240617161502305</figcaption>
</figure>
<p>然后再base+0x24324的地方下断点</p>
<figure>
<img src="./img/image-20240617161515281.png"
alt="image-20240617161515281" />
<figcaption aria-hidden="true">image-20240617161515281</figcaption>
</figure>
<p>然后debugger-&gt;debugger option-&gt;取消我们之前的event条件断点</p>
<p>然后F9。</p>
<p>当我们按下按钮，IDA就会停下来</p>
<figure>
<img src="./img/image-20240617161541540.png"
alt="image-20240617161541540" />
<figcaption aria-hidden="true">image-20240617161541540</figcaption>
</figure>
<h1 id="触发加载">触发加载</h1>
<p>很多操作类似于<code>自动加载</code></p>
<p>只不过触发加载中，so的加载是用户直接或者间接触发的</p>
<p>以load-mindle.apk为例。</p>
<p>我们的断点仍然在base+0x24324的地方，定位的依据仍然是字符串的引用<code>Hello from C++</code></p>
<p>1），root启动server</p>
<pre><code>c:\&gt;adb shell
PBCM10:/ $ su
PBCM10:/ # cd /data/local/tmp/dbg
PBCM10:/data/local/tmp/dbg # ./android_server64-v7.7
IDA Android 64-bit remote debug server(ST) v7.7.27. Hex-Rays (c) 2004-2022
Listening on 0.0.0.0:23946...</code></pre>
<p>2），端口转发</p>
<pre><code>C:\Users\tinyx&gt;adb forward tcp:23946 tcp:23946
23946</code></pre>
<p>3），手机启动app</p>
<p>也就是在手机中双击启动</p>
<p>4），打开空白的IDA</p>
<figure>
<img src="./img/image-20240617162316975.png"
alt="image-20240617162316975" />
<figcaption aria-hidden="true">image-20240617162316975</figcaption>
</figure>
<p>之后填写ip 127.0.0.1</p>
<p>然后在进程列表找到
目标进程com.example.myapplication_002，双击，IDA加载apk进程后，</p>
<p>让IDA分析2-3秒，然后F9</p>
<p>5），设置event条件断点</p>
<p>工具栏-&gt;debugger-&gt;debug option</p>
<figure>
<img src="./img/image-20240617162632385.png"
alt="image-20240617162632385" />
<figcaption aria-hidden="true">image-20240617162632385</figcaption>
</figure>
<p>用户触发，然后so被load，此刻我们可以停止一下</p>
<p>当我们点击按钮，IDA停下来，因为so被加载了</p>
<figure>
<img src="./img/image-20240617162806725.png"
alt="image-20240617162806725" />
<figcaption aria-hidden="true">image-20240617162806725</figcaption>
</figure>
<p>然后在modules模块找到目标so，然后去往基地址</p>
<figure>
<img src="./img/image-20240617162839176.png"
alt="image-20240617162839176" />
<figcaption aria-hidden="true">image-20240617162839176</figcaption>
</figure>
<p>然后在base+0x24324地方下断点</p>
<figure>
<img src="./img/image-20240617162914264.png"
alt="image-20240617162914264" />
<figcaption aria-hidden="true">image-20240617162914264</figcaption>
</figure>
<p>然后继续F9，就可以发现它断在了base+0x24324了</p>
<figure>
<img src="./img/image-20240617162949240.png"
alt="image-20240617162949240" />
<figcaption aria-hidden="true">image-20240617162949240</figcaption>
</figure>
            </div>
    </div>
  </div>
  <script src="https://vjs.zencdn.net/5.4.4/video.js"></script>

</body>
</html>
