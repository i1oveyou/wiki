<!doctype html>
<html >
<head>
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <!--[if lt IE 9]>
                <script src="http://css3-mediaqueries-js.googlecode.com/svn/trunk/css3-mediaqueries.js"></script>
        <![endif]-->
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta http-equiv="Content-Style-Type" content="text/css" />

    <!-- <link rel="stylesheet" type="text/css" href="template.css" /> -->
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/diversen/pandoc-bootstrap-adaptive-template@959c3622/template.css" />

    <link href="https://vjs.zencdn.net/5.4.4/video-js.css" rel="stylesheet" />

    <script src="https://code.jquery.com/jquery-2.2.1.min.js"></script>
    <!-- <script type='text/javascript' src='menu/js/jquery.cookie.js'></script> -->
    <!-- <script type='text/javascript' src='menu/js/jquery.hoverIntent.minified.js'></script> -->
    <!-- <script type='text/javascript' src='menu/js/jquery.dcjqaccordion.2.7.min.js'></script> -->

    <!-- <link href="menu/css/skins/blue.css" rel="stylesheet" type="text/css" /> -->
    <!-- <link href="menu/css/skins/graphite.css" rel="stylesheet" type="text/css" /> -->
    <!-- <link href="menu/css/skins/grey.css" rel="stylesheet" type="text/css" /> -->
  
    <!-- <script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script> -->
        
  
    <!-- <script src="script.js"></script> -->
  
    <!-- <script src="jquery.sticky-kit.js "></script> -->
    <script type='text/javascript' src='https://cdn.jsdelivr.net/gh/diversen/pandoc-bootstrap-adaptive-template@959c3622/menu/js/jquery.cookie.js'></script>
    <script type='text/javascript' src='https://cdn.jsdelivr.net/gh/diversen/pandoc-bootstrap-adaptive-template@959c3622/menu/js/jquery.hoverIntent.minified.js'></script>
    <script type='text/javascript' src='https://cdn.jsdelivr.net/gh/diversen/pandoc-bootstrap-adaptive-template@959c3622/menu/js/jquery.dcjqaccordion.2.7.min.js'></script>

    <link href="https://cdn.jsdelivr.net/gh/diversen/pandoc-bootstrap-adaptive-template@959c3622/menu/css/skins/blue.css" rel="stylesheet" type="text/css" />
    <link href="https://cdn.jsdelivr.net/gh/diversen/pandoc-bootstrap-adaptive-template@959c3622/menu/css/skins/graphite.css" rel="stylesheet" type="text/css" />
    <link href="https://cdn.jsdelivr.net/gh/diversen/pandoc-bootstrap-adaptive-template@959c3622/menu/css/skins/grey.css" rel="stylesheet" type="text/css" />
  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
  
    <script src="https://cdn.jsdelivr.net/gh/diversen/pandoc-bootstrap-adaptive-template@959c3622/script.js"></script>
  
    <script src="https://cdn.jsdelivr.net/gh/diversen/pandoc-bootstrap-adaptive-template@959c3622/jquery.sticky-kit.js"></script>
    <meta name="generator" content="pandoc" />
  <title>wiki-Reverse-winRe-shellcode-说在前面</title>
  <style type="text/css">code{white-space: pre;}</style>
</head>
<body>

    
    <div class="navbar navbar-static-top">
    <div class="navbar-inner">
      <div class="container">
        <span class="doc-title">wiki-Reverse-winRe-shellcode-说在前面</span>
        <ul class="nav pull-right doc-info">
                            </ul>
      </div>
    </div>
  </div>
    <div class="container">
    <div class="row">
            <div id="TOC" class="span3">
        <div class="well toc">

        <ul>
        <li><a href="#shellcode介绍"
        id="toc-shellcode介绍">shellcode介绍</a></li>
        <li><a href="#比较牛逼的文章"
        id="toc-比较牛逼的文章">比较牛逼的文章</a></li>
        <li><a href="#功能性shellcode的概念"
        id="toc-功能性shellcode的概念">功能性shellcode的概念</a></li>
        <li><a href="#高级语言的选择"
        id="toc-高级语言的选择">高级语言的选择</a></li>
        <li><a href="#核心理念" id="toc-核心理念">核心理念</a></li>
        <li><a href="#准备c项目" id="toc-准备c项目">准备C项目</a></li>
        <li><a href="#为shellcode减肥"
        id="toc-为shellcode减肥">为shellcode减肥</a></li>
        <li><a href="#开源的github"
        id="toc-开源的github">开源的Github</a></li>
        </ul>

        </div>
      </div>
            <div class="span9">

      
      <h1 id="shellcode介绍">shellcode介绍</h1>
<h1 id="比较牛逼的文章">比较牛逼的文章</h1>
<p>太长了</p>
<p>https://tttang.com/user/P3nro5e</p>
<h1 id="功能性shellcode的概念">功能性shellcode的概念</h1>
<p>这是一个攻防对抗很激烈的年代，杀毒软件的查杀技术是立体的，特征码、云、主防、启发、虚拟机。</p>
<p>如果恶意代码还只局限在必须依赖固定的PE格式，无法快速变异和免杀。</p>
<p>这要求恶意代码经过简单的处理就应该能躲过静态检测，不依赖于windows本身的loader可以加载运行</p>
<p>而shellcode正好符合这种形式,</p>
<p>传统意义上的shellcode对长度容易产生苛刻要求,必须得短小,那样在漏洞利用场景才会更方便</p>
<p><strong>功能性shellcode</strong>强调一个功能,是一段可能源代码有几千或者上万行</p>
<p>很明显，由于代码行数或者对于功能性的要求，使用纯汇编来进行功能性shellcode的编写是很不划算的。</p>
<p>功能性shellcode的编写主要还是用来对抗杀毒软件进行快速免杀的。</p>
<p>恶意代码封装成shellcode 对抗特征码和云</p>
<p>代码自修改技术多层SMC 对抗启发和虚拟机和云</p>
<p>random代码段和PE结构。 对抗杀软PE结构查杀和云</p>
<p>白名单技术 对抗国外杀软主防</p>
<p><strong>关于多层SMC</strong></p>
<p>因为存储这API地址的hash区域(ShellData)需要经过多次解密(密钥)才能还原出真实的API地址。</p>
<p>并且恶意代码的api地址全都从ShellData区域引出，我们可以很轻松的将密钥写入一个注册表键值或者bin文件亦或者</p>
<p>从网络上收包来接收这个用于SMC的密钥，杀软的虚拟机根本无从模拟我们恶意代码的API调用。</p>
<p>原来,,这就可以防止被解密,被杀软窥探,,</p>
<p><strong>关于random代码段和PE结构</strong>。</p>
<p>现有的方法如使用下面的指令。</p>
<pre><code>#pragma code_seg(push,r2,&quot;.test&quot;)
Some your backdoor code
#pragma code_seg(pop,r2)</code></pre>
<p>把自的恶意代码添加到一个.test段中或者使用下面的合并区段的指令。</p>
<pre><code>#pragma comment(linker, &quot;/MERGE:.rdata=.data&quot;)   //把rdata区段合并到data区段里
#pragma comment(linker, &quot;/MERGE:.text=.data&quot;)    //把text区段合并到data区段里
#pragma comment(linker, &quot;/MERGE:.reloc=.data&quot;    //把reloc区段合并到data区段里</code></pre>
<p>很容易就被判定PE是被人工修饰过的，会被启发杀到PE结构。</p>
<p>使用dup指令占位.text段，配合上SMC，几乎可以控制恶意代码的每一个字节。</p>
<h1 id="高级语言的选择">高级语言的选择</h1>
<h1 id="核心理念">核心理念</h1>
<p>我们创建shellcodes的方法就是利用C编译器可以从C代码生成汇编代码的特性，它包含了如下几个基础步骤：</p>
<ul>
<li>准备一个C项目</li>
<li>将该项目重构，所有的导入函数都通过PEB查找的方式进行（移除导入表中的依赖）</li>
<li>使用C编译器生成汇编代码：<code>cl /c /FA /GS- &lt;file_name&gt;.cpp</code></li>
<li>重构汇编代码，以使得其遵循shellcode的准则（移除其他剩余的依赖，将字符串和变量等改为内联）</li>
<li>将汇编代码进行编译：<code>cl /c file.asm</code></li>
<li>链接为PE文件，测试运行是否正常</li>
<li>获取.text中的代码，可以使用<a
href="https://github.com/wqreytuk/pe_parser#2022-10-02-更新">pe-parser</a>，这个提取出来的代码就是shellcode</li>
</ul>
<p>C编译器生成的汇编代码有时候并不是100%正确的，有时需要手动进行修改</p>
<h1 id="准备c项目">准备C项目</h1>
<p>当我们为shellcode准备C项目的时候，我们需要遵守以下几个规则：</p>
<ul>
<li>不要直接使用导入表</li>
<li>总是通过PEB获取API地址</li>
<li>不要使用任何静态库</li>
<li>只是用局部变量，不要用全局变量和静态变量（否则它们会被存储到另外的section中从而破坏代码的位置无关性）</li>
<li>使用基于栈的字符串（或者在生成的汇编代码中内联）</li>
</ul>
<p><a
href="http://144.34.164.217/agsduiagsdaigiada.html">基于栈的字符串转换</a></p>
<p>下面进行演示，我们的代码会弹个窗</p>
<h1 id="为shellcode减肥">为shellcode减肥</h1>
<figure>
<img src="./img/image-20231215134915622.png"
alt="image-20231215134915622" />
<figcaption aria-hidden="true">image-20231215134915622</figcaption>
</figure>
<h1 id="开源的github">开源的Github</h1>
<p>https://github.com/Pizz33/GobypassAV-shellcode</p>
<p>pe到shellcode</p>
<p>https://github.com/hasherezade/pe_to_shellcode</p>
<p>我怀疑是一个peloader罢了</p>
            </div>
    </div>
  </div>
  <script src="https://vjs.zencdn.net/5.4.4/video.js"></script>

</body>
</html>
