<!doctype html>
<html >
<head>
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <!--[if lt IE 9]>
                <script src="http://css3-mediaqueries-js.googlecode.com/svn/trunk/css3-mediaqueries.js"></script>
        <![endif]-->
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta http-equiv="Content-Style-Type" content="text/css" />

    <!-- <link rel="stylesheet" type="text/css" href="template.css" /> -->
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/diversen/pandoc-bootstrap-adaptive-template@959c3622/template.css" />

    <link href="https://vjs.zencdn.net/5.4.4/video-js.css" rel="stylesheet" />

    <script src="https://code.jquery.com/jquery-2.2.1.min.js"></script>
    <!-- <script type='text/javascript' src='menu/js/jquery.cookie.js'></script> -->
    <!-- <script type='text/javascript' src='menu/js/jquery.hoverIntent.minified.js'></script> -->
    <!-- <script type='text/javascript' src='menu/js/jquery.dcjqaccordion.2.7.min.js'></script> -->

    <!-- <link href="menu/css/skins/blue.css" rel="stylesheet" type="text/css" /> -->
    <!-- <link href="menu/css/skins/graphite.css" rel="stylesheet" type="text/css" /> -->
    <!-- <link href="menu/css/skins/grey.css" rel="stylesheet" type="text/css" /> -->
  
    <!-- <script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script> -->
        
  
    <!-- <script src="script.js"></script> -->
  
    <!-- <script src="jquery.sticky-kit.js "></script> -->
    <script type='text/javascript' src='https://cdn.jsdelivr.net/gh/diversen/pandoc-bootstrap-adaptive-template@959c3622/menu/js/jquery.cookie.js'></script>
    <script type='text/javascript' src='https://cdn.jsdelivr.net/gh/diversen/pandoc-bootstrap-adaptive-template@959c3622/menu/js/jquery.hoverIntent.minified.js'></script>
    <script type='text/javascript' src='https://cdn.jsdelivr.net/gh/diversen/pandoc-bootstrap-adaptive-template@959c3622/menu/js/jquery.dcjqaccordion.2.7.min.js'></script>

    <link href="https://cdn.jsdelivr.net/gh/diversen/pandoc-bootstrap-adaptive-template@959c3622/menu/css/skins/blue.css" rel="stylesheet" type="text/css" />
    <link href="https://cdn.jsdelivr.net/gh/diversen/pandoc-bootstrap-adaptive-template@959c3622/menu/css/skins/graphite.css" rel="stylesheet" type="text/css" />
    <link href="https://cdn.jsdelivr.net/gh/diversen/pandoc-bootstrap-adaptive-template@959c3622/menu/css/skins/grey.css" rel="stylesheet" type="text/css" />
  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
  
    <script src="https://cdn.jsdelivr.net/gh/diversen/pandoc-bootstrap-adaptive-template@959c3622/script.js"></script>
  
    <script src="https://cdn.jsdelivr.net/gh/diversen/pandoc-bootstrap-adaptive-template@959c3622/jquery.sticky-kit.js"></script>
    <meta name="generator" content="pandoc" />
  <title>wiki-Reverse-winRe-反调试-1.R3-1.如何发现调试器-5.Exception</title>
  <style type="text/css">code{white-space: pre;}</style>
  <style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>
</head>
<body>

    
    <div class="navbar navbar-static-top">
    <div class="navbar-inner">
      <div class="container">
        <span class="doc-title">wiki-Reverse-winRe-反调试-1.R3-1.如何发现调试器-5.Exception</span>
        <ul class="nav pull-right doc-info">
                            </ul>
      </div>
    </div>
  </div>
    <div class="container">
    <div class="row">
            <div id="TOC" class="span3">
        <div class="well toc">

        <ul>
        <li><a href="#前言" id="toc-前言">前言</a></li>
        <li><a href="#中断" id="toc-中断">中断</a>
        <ul>
        <li><a href="#tf异常" id="toc-tf异常">TF异常</a></li>
        <li><a href="#int-03" id="toc-int-03">int 03</a>
        <ul>
        <li><a href="#int-3" id="toc-int-3">int 3</a></li>
        <li><a href="#int-cd03" id="toc-int-cd03">int CD03</a></li>
        </ul></li>
        <li><a href="#int-0x2d" id="toc-int-0x2d">int 0x2D</a></li>
        </ul></li>
        <li><a href="#基于veh-uef-vch" id="toc-基于veh-uef-vch">基于VEH
        UEF VCH</a>
        <ul>
        <li><a href="#vch" id="toc-vch">VCH</a></li>
        <li><a href="#uef" id="toc-uef">UEF</a></li>
        </ul></li>
        <li><a href="#另类异常" id="toc-另类异常">另类异常</a></li>
        <li><a href="#outputdebugstring进化成功"
        id="toc-outputdebugstring进化成功">OutputDebugString进化(成功)</a></li>
        <li><a href="#ctrl-c异常-失败" id="toc-ctrl-c异常-失败">Ctrl
        C异常 (失败)</a></li>
        <li><a href="#鼠键勾取失败"
        id="toc-鼠键勾取失败">鼠键勾取(失败)</a></li>
        <li><a href="#故意触发错误非异常"
        id="toc-故意触发错误非异常">故意触发错误(非异常)</a></li>
        </ul>

        </div>
      </div>
            <div class="span9">

      
      <h1 id="前言">前言</h1>
<p>异常处理函数都可以去调试</p>
<p>可能有些异常处理函数是用线程的方式去实现的,不好及时发现并调试</p>
<p>有些异常处理函数是你没有下F2断点,也不好调试,甚至我们找不到异常处理函数呢</p>
<p>不管如何利用异常去触发一个反调试</p>
<p>其目的都是让调试器去干扰一个流程的执行</p>
<p>有些流程调试器甚至都无法干扰,还会g</p>
<figure>
<img src="img/image-20230809111356277.png"
alt="image-20230809111356277" />
<figcaption aria-hidden="true">image-20230809111356277</figcaption>
</figure>
<p>利用API去主动触发一个异常</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>VOID RaiseException <span class="op">(</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>    DWORD dwExceptionCode<span class="op">,</span><span class="co">//异常代码</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>    DwORD dwExceptionFlags<span class="op">,</span><span class="co">//继续执行标志</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>    DWORD nNumberofArguments<span class="op">,</span><span class="co">//参数个数</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>    CONST DWORD <span class="op">*</span>lpArguments<span class="co">//[指向参数缓冲区的指针</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="op">);</span></span></code></pre></div>
<h1 id="中断">中断</h1>
<h2 id="tf异常">TF异常</h2>
<p>Trap Flag（陷阱标识）位于EFLAGS寄存器内，如果TF设置为1，</p>
<p>当 TF 标志位被设置为 1 时，CPU
在每执行完一条指令后会触发调试异常（Debug
Exception），使得程序运行以单步模式执行，</p>
<p>这可以帮助调试人员逐条执行程序代码，对程序的每一步进行跟踪和调试。</p>
<p>每执行一条指令后，CPU
将会暂停，并引发一个调试中断异常，使得调试器有机会检查和修改 CPU
寄存器、内存等信息。</p>
<p>在实际的调试过程中，通常不会直接观察到 TF 标志位被设置为 1。</p>
<p>这是因为调试器会负责处理 TF
标志位，<strong>并根据需要进行设置和清除。</strong></p>
<figure>
<img src="img/image-20230809113850703.png"
alt="image-20230809113850703" />
<figcaption aria-hidden="true">image-20230809113850703</figcaption>
</figure>
<p>遇到TF异常后</p>
<p>选择Single step, 不会有什么可怕的事情发生,IDA会去处理这个异常,
结果是继续单步运行,</p>
<p>如果选择run, IDA不会去处理那个异常,不再控制由TF=1导致的异常</p>
<p>Example</p>
<p>基于手动写入SEH</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#define _CRT_SECURE_NO_WARNINGS</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;windows.h&gt;</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdlib.h&gt;</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> DynAD_SingleStep<span class="op">()</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">&quot;Trap Flag (Single Step)</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">);</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>    <span class="dt">char</span> dbg<span class="op">[]</span> <span class="op">=</span> <span class="st">&quot;Find You&quot;</span><span class="op">;</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>    <span class="dt">char</span> title<span class="op">[]</span> <span class="op">=</span> <span class="st">&quot;redqx&quot;</span><span class="op">;</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>    __asm <span class="op">{</span></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>    install_SEH<span class="op">:</span></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>        push handler<span class="op">;</span></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>        push DWORD ptr fs <span class="op">:</span> <span class="op">[</span><span class="dv">0</span><span class="op">]</span> <span class="op">;</span></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>        mov DWORD ptr fs <span class="op">:</span> <span class="op">[</span><span class="dv">0</span><span class="op">]</span> <span class="op">,</span> esp<span class="op">;</span></span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>        pushfd<span class="op">;</span> <span class="co">//把所有的寄存器入栈</span></span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a>        or dword ptr ss <span class="op">:</span> <span class="op">[</span>esp<span class="op">]</span> <span class="op">,</span> <span class="bn">0x100</span><span class="op">;</span> <span class="co">//对栈中寄存器的TF数据做一个修改</span></span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>        popfd<span class="op">;</span> <span class="co">//把栈中修改的数据放入寄存器</span></span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a>        nop<span class="op">;</span></span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a>        <span class="co">//触发异常 这个异常如果不解决的话,IDA会来到这里,然后崩溃</span></span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a>        xor eax<span class="op">,</span> eax<span class="op">;</span></span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a>        push eax<span class="op">;</span></span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a>        lea ebx<span class="op">,</span> title<span class="op">;</span></span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a>        push ebx<span class="op">;</span></span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a>        lea ebx<span class="op">,</span> dbg<span class="op">;</span></span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a>        push ebx<span class="op">;</span></span>
<span id="cb2-31"><a href="#cb2-31" aria-hidden="true" tabindex="-1"></a>        push eax<span class="op">;</span></span>
<span id="cb2-32"><a href="#cb2-32" aria-hidden="true" tabindex="-1"></a>        call MessageBoxA<span class="op">;</span></span>
<span id="cb2-33"><a href="#cb2-33" aria-hidden="true" tabindex="-1"></a>        mov eax<span class="op">,</span> <span class="bn">0xFFFFFFFF</span><span class="op">;</span></span>
<span id="cb2-34"><a href="#cb2-34" aria-hidden="true" tabindex="-1"></a>        jmp eax<span class="op">;</span><span class="co">//然后触发其它异常,导致崩溃</span></span>
<span id="cb2-35"><a href="#cb2-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-36"><a href="#cb2-36" aria-hidden="true" tabindex="-1"></a>    handler <span class="op">:</span></span>
<span id="cb2-37"><a href="#cb2-37" aria-hidden="true" tabindex="-1"></a>        mov eax<span class="op">,</span> dword ptr ss <span class="op">:</span> <span class="op">[</span>esp <span class="op">+</span> <span class="bn">0xc</span><span class="op">]</span> <span class="op">;</span><span class="co">//获取第3个参数 ContextRecord</span></span>
<span id="cb2-38"><a href="#cb2-38" aria-hidden="true" tabindex="-1"></a>        mov ebx<span class="op">,</span> remove_SEH<span class="op">;</span><span class="co">//把EIP指向最后的安全退出函数</span></span>
<span id="cb2-39"><a href="#cb2-39" aria-hidden="true" tabindex="-1"></a>        mov dword ptr ds <span class="op">:</span> <span class="op">[</span>eax <span class="op">+</span> <span class="bn">0xb8</span><span class="op">]</span> <span class="op">,</span> ebx<span class="op">;</span><span class="co">//ContextRecord-&gt;EIP= remove_SEH</span></span>
<span id="cb2-40"><a href="#cb2-40" aria-hidden="true" tabindex="-1"></a>        xor eax<span class="op">,</span> eax<span class="op">;</span></span>
<span id="cb2-41"><a href="#cb2-41" aria-hidden="true" tabindex="-1"></a>        retn<span class="op">;</span></span>
<span id="cb2-42"><a href="#cb2-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-43"><a href="#cb2-43" aria-hidden="true" tabindex="-1"></a>    remove_SEH <span class="op">:</span></span>
<span id="cb2-44"><a href="#cb2-44" aria-hidden="true" tabindex="-1"></a>        pop dword ptr fs <span class="op">:</span> <span class="op">[</span><span class="dv">0</span><span class="op">]</span> <span class="op">;</span><span class="co">//pop到</span></span>
<span id="cb2-45"><a href="#cb2-45" aria-hidden="true" tabindex="-1"></a>        add esp<span class="op">,</span> <span class="dv">4</span><span class="op">;</span></span>
<span id="cb2-46"><a href="#cb2-46" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb2-47"><a href="#cb2-47" aria-hidden="true" tabindex="-1"></a>    MessageBox<span class="op">(</span>NULL<span class="op">,</span> <span class="st">&quot;where are you</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">,</span> <span class="st">&quot;redqx&quot;</span><span class="op">,</span> MB_OK<span class="op">);</span></span>
<span id="cb2-48"><a href="#cb2-48" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb2-49"><a href="#cb2-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-50"><a href="#cb2-50" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">()</span></span>
<span id="cb2-51"><a href="#cb2-51" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb2-52"><a href="#cb2-52" aria-hidden="true" tabindex="-1"></a>    DynAD_SingleStep<span class="op">();</span></span>
<span id="cb2-53"><a href="#cb2-53" aria-hidden="true" tabindex="-1"></a>    puts<span class="op">(</span><span class="st">&quot;hELLO WorLD&quot;</span><span class="op">);</span></span>
<span id="cb2-54"><a href="#cb2-54" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb2-55"><a href="#cb2-55" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>基于try except</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#define _CRT_SECURE_NO_WARNINGS</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;windows.h&gt;</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdlib.h&gt;</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> test<span class="op">()</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>    BOOL isDebugged <span class="op">=</span> TRUE<span class="op">;</span></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>    __try</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>        __asm</span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>        <span class="op">{</span></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>            <span class="co">//这里本身就是一个异常的触发</span></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>            pushfd</span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>            or dword ptr<span class="op">[</span>esp<span class="op">],</span> <span class="bn">0x100</span> <span class="co">// set the Trap Flag</span></span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>            popfd                    <span class="co">// Load the value into EFLAGS register</span></span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>            nop</span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a>    __except <span class="op">(</span>EXCEPTION_EXECUTE_HANDLER<span class="op">)</span><span class="co">//如果调试器不处理,那么在异常那里继续执行,但是该异常不是一个错误异常?不会再次触发错误死循环?</span></span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a>        isDebugged <span class="op">=</span> FALSE<span class="op">;</span></span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>isDebugged<span class="op">)</span><span class="co">//调试器处理后,如果选择不处理,那么该BOOL值会是1,否则会是0</span></span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a>        MessageBox<span class="op">(</span>NULL<span class="op">,</span> <span class="st">&quot;Find You&quot;</span><span class="op">,</span> <span class="st">&quot;redqx&quot;</span><span class="op">,</span> MB_OK<span class="op">);</span> <span class="co">//确实会被运行</span></span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a>        exit<span class="op">(-</span><span class="dv">1</span><span class="op">);</span></span>
<span id="cb3-29"><a href="#cb3-29" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb3-30"><a href="#cb3-30" aria-hidden="true" tabindex="-1"></a>    MessageBox<span class="op">(</span>NULL<span class="op">,</span> <span class="st">&quot;Where Are You?&quot;</span><span class="op">,</span> <span class="st">&quot;redqx&quot;</span><span class="op">,</span> MB_OK<span class="op">);</span> <span class="co">//确实会被运行</span></span>
<span id="cb3-31"><a href="#cb3-31" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span><span class="op">;</span></span>
<span id="cb3-32"><a href="#cb3-32" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb3-33"><a href="#cb3-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-34"><a href="#cb3-34" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">()</span></span>
<span id="cb3-35"><a href="#cb3-35" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb3-36"><a href="#cb3-36" aria-hidden="true" tabindex="-1"></a>    test<span class="op">();</span></span>
<span id="cb3-37"><a href="#cb3-37" aria-hidden="true" tabindex="-1"></a>    puts<span class="op">(</span><span class="st">&quot;hELLO WorLD&quot;</span><span class="op">);</span></span>
<span id="cb3-38"><a href="#cb3-38" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb3-39"><a href="#cb3-39" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>之前是通过EFLAG的TF标志位让程序出现异常</p>
<p>我们也可以通过icebp指令来设置一个和之前效果类似的异常</p>
<p>运行<code>ICEBP</code>(<code>0xF1</code>)指令将会产生一个单步异常,</p>
<p>如果通过单步调试跟踪程序,</p>
<p>调试器会认为这是单步调试产生的异常,从而不执行先前设置的异常处理例程</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;windows.h&gt;</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>DWORD CheckDebug<span class="op">()</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>    __try</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>        __asm<span class="op">{</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>            __emit <span class="bn">0xF1</span><span class="op">;</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>    __except <span class="op">(</span>EXCEPTION_EXECUTE_HANDLER<span class="op">)</span></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> FALSE<span class="op">;</span><span class="co">//交给程序自身处理</span></span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">1</span><span class="op">;</span> </span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">()</span></span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>CheckDebug<span class="op">())</span></span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a>        printf<span class="op">(</span><span class="st">&quot;Check You</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">);</span></span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span></span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a>        printf<span class="op">(</span><span class="st">&quot;Where are you</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">);</span></span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-29"><a href="#cb4-29" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb4-30"><a href="#cb4-30" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h2 id="int-03">int 03</h2>
<h3 id="int-3">int 3</h3>
<p>陷阱异常 就是怎么执行它,都会出错</p>
<p>嵌入汇编引起异常</p>
<p>问题来了:</p>
<p>我安装的异常为什么是int3的解决方案????</p>
<p>其实就是在关键地方触发</p>
<pre><code>            int 3 //异常1
            //如果不处理异常,会来到这里
            mov eax, 0xFFFFFFFF
            jmp eax    //异常2</code></pre>
<p>实际的代码可以参考单步异常int1那个例子写,修改的部分很少很少</p>
<h3 id="int-cd03">int CD03</h3>
<p>双字节操作码<code>0xCD03</code>也可以产生<code>INT 3</code>中断,在<code>WinDbg</code>调试器内,</p>
<p>由于断点通常是单字节机器码<code>0xCC</code>,</p>
<p>因此<code>WinDbg</code>会捕获这个断点然后将<code>EIP</code>加<code>1</code>字节,导致程序崩溃</p>
<p>实际的代码可以参考单步异常int1那个例子写,修改的部分很少很少</p>
<pre><code>#include &lt;stdio.h&gt;
#include &lt;windows.h&gt;
int DbgCheck()
{
    __try
    {
        __asm
        {
            __emit 0xCD
            __emit 0x03
        }
    }
    __except (1)
    {
        return FALSE;
    }
    return TRUE;
}</code></pre>
<h2 id="int-0x2d">int 0x2D</h2>
<p>第 0x2d（45） 号中断处理函数是 KiDebugService</p>
<p>int 2d 本来是被内核 ntroskrnl.exe 运行 <code>DebugServices</code>
用的,</p>
<p>但是也可以在RING 3模式下使用它.</p>
<p>在调试模式中执行<code>INT 2D</code>指令,下一条指令的第一个字节将被忽略;</p>
<p>使用<code>StepInto(F7)</code>或者<code>StepOver(F8)</code>命令跟踪<code>INT 2D</code>指令,</p>
<p>程序不会停在下一条指令开始的地方,而是一直运行,就像<code>RUN(F9)</code>一样.</p>
<p>也就是在程序没有<code>int 0x2D</code>后面一些地方下断点的话</p>
<p>程序会跑飞</p>
<p>如果在一个正常的程序中使用 int 2d ,将会发生异常,</p>
<p>所以也就是:</p>
<p>程序正常运行引出异常</p>
<p>程序被调试运行不会抛出异常</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>    push   offset _seh</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>    push   fs<span class="op">:[</span><span class="dv">0</span><span class="op">]</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>    mov    fs<span class="op">:[</span><span class="dv">0</span><span class="op">],</span> esp       <span class="op">;</span>install SEH</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span>      <span class="dv">2</span><span class="er">dh</span>             <span class="op">;</span>如果有调试器<span class="op">,</span>正常运行<span class="op">;</span>否则<span class="op">,</span>会触发异常</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>    nop</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>    pop     fs<span class="op">:[</span><span class="dv">0</span><span class="op">]</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>    add     esp<span class="op">,</span> <span class="dv">4</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>    <span class="op">;</span>检测到调试器</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>    _seh<span class="op">:</span> <span class="op">;</span>溢出处理</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>    <span class="op">;</span>未检测到调试器</span></code></pre></div>
<p>另外就是关于int 0x2D发生异常后,该指令后一字节会被忽略的问题</p>
<p>这个关键的一个字节可以用于修改流程</p>
<p>流程的修改需要自己去精巧的构造</p>
<p>如果要去构造的话,有一些地方得注意</p>
<ol type="1">
<li>正常运行int 0x2D 得有异常处理函数</li>
<li>调试运行,得注意流程的构造</li>
</ol>
<p>x86 Example</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;windows.h&gt;</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> ant_int2D<span class="op">()</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>    BOOL    bDebugging <span class="op">=</span> FALSE<span class="op">;</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span>     mY_Echo <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>    _asm <span class="op">{</span></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>    install_SEH<span class="op">:</span></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>            pusha</span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>            lea esi<span class="op">,</span> mY_Echo</span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>            mov ecx<span class="op">,</span> <span class="op">[</span>esi<span class="op">]</span></span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>            push handler</span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>            push DWORD ptr fs <span class="op">:</span> <span class="op">[</span><span class="dv">0</span><span class="op">]</span></span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>            mov  DWORD ptr  fs <span class="op">:</span> <span class="op">[</span><span class="dv">0</span><span class="op">]</span> <span class="op">,</span> esp</span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a>            xor ecx<span class="op">,</span>ecx</span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a>            <span class="dt">int</span> <span class="bn">0x2d</span></span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a>            inc ecx</span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a>            <span class="co">//如果发生异常,这个int 0x2d后面那个字节inc ecx 不会被执行</span></span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a>            <span class="co">//如果没发生异常,int 0x2d后面那个字节是会被执行的</span></span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a>            mov<span class="op">[</span>esi<span class="op">],</span> ecx</span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a>            mov bDebugging<span class="op">,</span> <span class="dv">1</span></span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a>            jmp remove_SEH</span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true" tabindex="-1"></a>            handler <span class="op">:</span> <span class="co">//异常处理函数不会有参数的压入??</span></span>
<span id="cb8-27"><a href="#cb8-27" aria-hidden="true" tabindex="-1"></a>            mov eax<span class="op">,</span> dword ptr ss <span class="op">:</span> <span class="op">[</span>esp <span class="op">+</span> <span class="bn">0xc</span><span class="op">]</span></span>
<span id="cb8-28"><a href="#cb8-28" aria-hidden="true" tabindex="-1"></a>            mov dword ptr ds <span class="op">:</span> <span class="op">[</span>eax <span class="op">+</span> <span class="bn">0xb8</span><span class="op">]</span> <span class="op">,</span> offset remove_SEH</span>
<span id="cb8-29"><a href="#cb8-29" aria-hidden="true" tabindex="-1"></a>            mov bDebugging<span class="op">,</span> <span class="dv">0</span></span>
<span id="cb8-30"><a href="#cb8-30" aria-hidden="true" tabindex="-1"></a>            xor eax<span class="op">,</span> eax</span>
<span id="cb8-31"><a href="#cb8-31" aria-hidden="true" tabindex="-1"></a>            retn</span>
<span id="cb8-32"><a href="#cb8-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-33"><a href="#cb8-33" aria-hidden="true" tabindex="-1"></a>            remove_SEH <span class="op">:</span></span>
<span id="cb8-34"><a href="#cb8-34" aria-hidden="true" tabindex="-1"></a>            pop dword ptr fs <span class="op">:</span> <span class="op">[</span><span class="dv">0</span><span class="op">]</span></span>
<span id="cb8-35"><a href="#cb8-35" aria-hidden="true" tabindex="-1"></a>            add esp<span class="op">,</span> <span class="dv">4</span></span>
<span id="cb8-36"><a href="#cb8-36" aria-hidden="true" tabindex="-1"></a>            popa</span>
<span id="cb8-37"><a href="#cb8-37" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb8-38"><a href="#cb8-38" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>bDebugging<span class="op">)</span></span>
<span id="cb8-39"><a href="#cb8-39" aria-hidden="true" tabindex="-1"></a>        MessageBox<span class="op">(</span>NULL<span class="op">,</span> <span class="st">&quot;Find YOu&quot;</span><span class="op">,</span> <span class="st">&quot;Xsir&quot;</span><span class="op">,</span> MB_OK<span class="op">);</span></span>
<span id="cb8-40"><a href="#cb8-40" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span></span>
<span id="cb8-41"><a href="#cb8-41" aria-hidden="true" tabindex="-1"></a>        MessageBox<span class="op">(</span>NULL<span class="op">,</span> <span class="st">&quot;where are you&quot;</span><span class="op">,</span> <span class="st">&quot;Xsir&quot;</span><span class="op">,</span> MB_OK<span class="op">);</span></span>
<span id="cb8-42"><a href="#cb8-42" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb8-43"><a href="#cb8-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-44"><a href="#cb8-44" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">()</span></span>
<span id="cb8-45"><a href="#cb8-45" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb8-46"><a href="#cb8-46" aria-hidden="true" tabindex="-1"></a>    ant_int2D<span class="op">();</span></span>
<span id="cb8-47"><a href="#cb8-47" aria-hidden="true" tabindex="-1"></a>    system<span class="op">(</span><span class="st">&quot;pause nul&quot;</span><span class="op">);</span></span>
<span id="cb8-48"><a href="#cb8-48" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb8-49"><a href="#cb8-49" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>把上面那个代码编译后</p>
<p>IDA就会出现一些提示的信息</p>
<pre><code>int sub_9018B0()
{
  __asm
  {
    pushaw
    int     2Dh; Windows NT - debugging services: eax = type
    popaw
  }
  return sub_90139D(&quot;=&gt; %d Debugging!!!\n\n&quot;, 1);
}</code></pre>
<p>X64 Example</p>
<p>直接在x64的C语言里面调用汇编生成的东西</p>
<p>6哇</p>
<p>文件如下</p>
<p>tets.asm</p>
<pre><code>.code

__int2d proc
    int 2dh
    nop
    ret
__int2d endp

end</code></pre>
<p>tets.asm我们得修改一下文件的生成选项</p>
<p>右键<code>test.asm</code>,然后点击<code>属性</code></p>
<p>注意是x64哟</p>
<figure>
<img src="./img/e1d657e68aaa4bf8a50cc1e0294ef50fUntitled1.png"
alt="Untitled" />
<figcaption aria-hidden="true">Untitled</figcaption>
</figure>
<p>然后设置一下自定义生成工具的选项</p>
<figure>
<img src="./img/e1d657e68aaa4bf8a50cc1e0294ef50fUntitled2.png"
alt="Untitled" />
<figcaption aria-hidden="true">Untitled</figcaption>
</figure>
<p>涉及的操作</p>
<pre><code>ml64 /Fo $(IntDir)%(fileName).obj /c %(fileName).asm
$(IntDir)%(fileName).obj</code></pre>
<p>src.c</p>
<pre><code>// Test_Console_1.cpp : 此文件包含 &quot;main&quot; 函数。程序执行将在此处开始并结束。
//

#include &lt;stdio.h&gt;
#include &lt;Windows.h&gt;

extern void __int2d();

int isDebugger = 1;

// 我们的异常接管函数
int CALLBACK VectoredHandler(_In_ PEXCEPTION_POINTERS ExceptionInfo)
{

    isDebugger = FALSE;;
    // 如果引发异常的是一个断点
    if (ExceptionInfo-&gt;ExceptionRecord-&gt;ExceptionCode == EXCEPTION_BREAKPOINT)
    {
        // 忽略该异常，继续执行
        return EXCEPTION_CONTINUE_EXECUTION;
    }

    // 继续向上一层 seh 查找异常处理方法
    return EXCEPTION_CONTINUE_SEARCH;
}

int main()
{
    // 注册 veh，1代表第一个被调用（非零都是第一个被调用）
    PVOID Handle = AddVectoredExceptionHandler(1, VectoredHandler);

    // 使用 int 2dh 触发异常
    __int2d();

    // 删除 veh
    if (Handle)
    {
        RemoveVectoredExceptionHandler(Handle);
    }

    // 判断调试器
    if (isDebugger == TRUE)
    {
        MessageBox(0, &quot;Find You&quot;, &quot;Xsir&quot;, 0);
    }
    else
    {
        MessageBox(0, &quot;Where are You&quot;, &quot;Xsir&quot;, 0);
    }
    return 0;
}</code></pre>
<p>然后我们的vs2022就可以生成运行了</p>
<p>基于相同的原理</p>
<pre><code>// Test_Console_1.cpp : 此文件包含 &quot;main&quot; 函数。程序执行将在此处开始并结束。
//

#include &lt;stdio.h&gt;
#include &lt;Windows.h&gt;

BOOL isDebugger = TRUE;

// 我们的异常回调处理函数
LONG CALLBACK VectoredHandler(_In_ PEXCEPTION_POINTERS ExceptionInfo) {
    isDebugger = FALSE;

    // 如果这个异常属于断点异常
    if (ExceptionInfo-&gt;ExceptionRecord-&gt;ExceptionCode == EXCEPTION_BREAKPOINT) {
        // 因为 int3 属于陷阱异常，中断完成后要回到产生异常的下一条指令（否则会一直产生 int3 陷入死循环）
#ifdef _WIN64
        ExceptionInfo-&gt;ContextRecord-&gt;Rip++;
#else
        ExceptionInfo-&gt;ContextRecord-&gt;Eip++;
#endif
        // 忽略异常继续执行
        return EXCEPTION_CONTINUE_EXECUTION;
    }

    // 继续向上一层 seh 查找异常处理方式
    return EXCEPTION_CONTINUE_SEARCH;
}

int main()
{
    // 注册 veh
    PVOID Handle = AddVectoredExceptionHandler(1, VectoredHandler);

    // 手动触发异常
    __debugbreak();//自动的int 3

    // 删除 veh
    RemoveVectoredExceptionHandler(Handle);

    // 判断调试器
    if (isDebugger == TRUE)
    {
       printf(&quot;发现调试器\n&quot;);
    }
    else
    {
        printf(&quot;没有调试器\n&quot;);
    }

    system(&quot;pause&quot;);
    return 0;
}</code></pre>
<h1 id="基于veh-uef-vch">基于VEH UEF VCH</h1>
<h2 id="vch">VCH</h2>
<p>也就一个断点的检测</p>
<pre><code>#include &lt;stdio.h&gt;
#include &lt;string.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;windows.h&gt;

LONG CALLBACK CheckDebug(PEXCEPTION_POINTERS ExceptionInfo)
{
    PCONTEXT ctx = ExceptionInfo-&gt;ContextRecord;
    if (ctx-&gt;Dr0 != 0 || ctx-&gt;Dr1 != 0 || ctx-&gt;Dr2 != 0 || ctx-&gt;Dr3 != 0)
    {
        printf(&quot;Stop debugging program!&quot;);

    }
    ctx-&gt;Eip += 2;
    return EXCEPTION_CONTINUE_EXECUTION;
}
int main()
{
    AddVectoredExceptionHandler(0, CheckDebug);
    __asm int 1h;//触发异常
    return 0;
}</code></pre>
<h2 id="uef">UEF</h2>
<p>就有一个疑惑</p>
<p>发生异常,然后跑去处理异常,异常处理之后,可能会再回来</p>
<p>这个过程中,真的保存了线程的结构体吗(保存环境)</p>
<p>没看懂</p>
<pre><code>#include &lt;stdio.h&gt;
#include &lt;windows.h&gt;

LONG WINAPI ExceptionFilter(PEXCEPTION_POINTERS pExcept)
{
    //.text:00411F8F 89 00                      mov[eax], eax
    //.text : 00411F91 68 00 7D 41 00           push    offset aNotDebugging; &quot;  =&gt; Not debugging...\n\n&quot;
    pExcept-&gt;ContextRecord-&gt;Eip += 2;
    return EXCEPTION_CONTINUE_EXECUTION;
}

void func()
{
    SetUnhandledExceptionFilter((LPTOP_LEVEL_EXCEPTION_FILTER)ExceptionFilter); //正常执行才会有的处理函数
    __asm
    {
        xor eax, eax;
        mov dword ptr[eax], eax //触发一个异常
    }
    MessageBox(0, &quot;Where are you?&quot;, &quot;Xsir&quot;, 0);
    return;
}

int main()
{
    func();
    return 0;
}</code></pre>
<pre><code>// Test_Console_1.cpp : 此文件包含 &quot;main&quot; 函数。程序执行将在此处开始并结束。
//

#include &lt;stdio.h&gt;
#include &lt;Windows.h&gt;

// 如果有调试器，则不会执行这个函数
BOOL bIsBeinDbg = TRUE;
LONG WINAPI UnhandledExcepFilter(PEXCEPTION_POINTERS pExcepPointers)
{
    bIsBeinDbg = FALSE;
    return EXCEPTION_CONTINUE_EXECUTION;
}

int main()
{
    // 注册异常处理函数
    LPTOP_LEVEL_EXCEPTION_FILTER Top = SetUnhandledExceptionFilter(UnhandledExcepFilter);

    // 主动抛出一个异常
    RaiseException(EXCEPTION_FLT_DIVIDE_BY_ZERO, 0, 0, NULL);

    if (bIsBeinDbg == TRUE)
    {
        printf(&quot;发现调试器\n&quot;);
    }
    else
    {
        printf(&quot;没有调试器！\n&quot;);;
    }

main_end:
    return 0;
}</code></pre>
<p>IDA的翻译</p>
<p>破解的方法很多</p>
<p>1.不用f7,用f2+f9</p>
<p>2.修改最后的计算结果</p>
<p>3.操作跳转指令</p>
<h1 id="另类异常">另类异常</h1>
<h1 id="outputdebugstring进化成功">OutputDebugString进化(成功)</h1>
<p>从Windows
10开始，Windows修改了<code>OutputDebugString</code>函数的实现，</p>
<p>改成带有特定参数的<code>RaiseException</code>调用。</p>
<p>因此，现在调试输出异常必须由调试器来处理</p>
<p>我们可以使用两种异常类型来检测是否存在调试器，</p>
<p>分别为<code>DBG_PRINTEXCEPTION_C</code>（<code>0x40010006</code>）</p>
<p>以及<code>DBG_PRINTEXCEPTION_W</code>（<code>0x4001000A</code>）</p>
<pre><code>#include &lt;stdio.h&gt;
#include &lt;string.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;windows.h&gt;
#define DBG_PRINTEXCEPTION_WIDE_C 0x4001000A

void checkDbg()
{

    char outputString[] = &quot;Can You See Me?&quot;;
    ULONG_PTR args[4] = { 0 };

    args[0] = (ULONG_PTR)strlen((char*)outputString) + 1;
    args[1] = (ULONG_PTR)outputString;
    __try
    {
        RaiseException(DBG_PRINTEXCEPTION_WIDE_C, 0, 4, args);
        MessageBox(0, &quot;Find you&quot;, &quot;Xsir&quot;, 0);
    }
    __except (EXCEPTION_EXECUTE_HANDLER)
    {
        MessageBox(0, &quot;Where Are you?&quot;, &quot;Xsir&quot;, 0);
    }
}
int main()
{
    checkDbg();
}</code></pre>
<p>因此，如果异常没有被处理，就意味着没有附加调试器。</p>
<p><code>DBG_PRINTEXCEPTION_W</code>用于宽字符输出，</p>
<p><code>DBG_PRINTEXCEPTION_C</code>用于<code>ansi</code>字符。</p>
<p>这意味着在使用<code>DBG_PRINTEXCEPTION_C</code>的情况下，</p>
<p><code>arg[0]</code>会保存<code>strlen()</code>的结果，而<code>args[1]</code>在指向<code>ansi</code>字符串（<code>char *</code>）</p>
<h1 id="ctrl-c异常-失败">Ctrl C异常 (失败)</h1>
<p>当用户按下Ctrl+C或Ctrl+Break并且控制台窗口处于focus位置时，</p>
<p>Windows会检查是否有这个事件的处理程序。所有的控制台进程都有一个默认的处理函数，</p>
<p>调用kernel32！ExitProcess()函数。</p>
<p>然而，我们可以为这些事件注册一个自定义的处理程序，它忽略了Ctrl+C或Ctrl+Break信号。</p>
<p>然而，如果一个控制台进程正在被调试，而CTRL+C信号没有被禁用，</p>
<p>系统会产生一个DBG_CONTROL_C异常。通常这个异常会被调试器拦截，</p>
<p>但是如果我们注册一个异常处理程序，我们将能够检查DBG_CONTROL_C是否被引发。</p>
<p>如果我们在自己的异常处理程序中拦截了DBG_CONTROL_C异常，</p>
<p>它可能表明该进程正在被调试。</p>
<p>C++代码：(未运行成功)</p>
<pre><code>bool g_bDebugged{ false };
std::atomic&lt;bool&gt; g_bCtlCCatched{ false };

static LONG WINAPI CtrlEventExeptionHandler(PEXCEPTION_POINTERS pExceptionInfo)
{
    if (pExceptionInfo-&gt;ExceptionRecord-&gt;ExceptionCode == DBG_CONTROL_C)
    {
        g_bDebugged = true;
        g_bCtlCCatched.store(true);
    }
    return EXCEPTION_CONTINUE_EXECUTION;
}

static BOOL WINAPI CtrlHandler(DWORD fdwCtrlType)
{
    switch (fdwCtrlType)
    {
    case CTRL_C_EVENT:
        g_bCtlCCatched.store(true);
        return TRUE;
    default:
        return FALSE;
    }
}

bool IsDebugged()
{
    PVOID hVeh = nullptr;
    BOOL bCtrlHadnlerSet = FALSE;

    __try
    {
        hVeh = AddVectoredExceptionHandler(TRUE, CtrlEventExeptionHandler);
        if (!hVeh)
            __leave;

        bCtrlHadnlerSet = SetConsoleCtrlHandler(CtrlHandler, TRUE);
        if (!bCtrlHadnlerSet)
            __leave;

        GenerateConsoleCtrlEvent(CTRL_C_EVENT, 0);
        while (!g_bCtlCCatched.load())
            ;
    }
    __finally
    {
        if (bCtrlHadnlerSet)
            SetConsoleCtrlHandler(CtrlHandler, FALSE);

        if (hVeh)
            RemoveVectoredExceptionHandler(hVeh);
    }

    return g_bDebugged;
}</code></pre>
<h1 id="鼠键勾取失败">鼠键勾取(失败)</h1>
<p>函数user32!BlockInput()可以阻止所有的鼠标和键盘事件，这是禁用调试器的一个相当有效的方法。</p>
<p>在Windows Vista和更高版本中，这个调用需要管理员权限。</p>
<p>我们还可以检测是否有钩住user32!BlockInput()和其他反调试调用的工具存在。</p>
<p>该函数只允许阻断输入一次。第二次调用将返回FALSE。如果该函数无论输入多少都返回TRUE，可能表明存在一些拦截方案</p>
<pre><code>#define EVENT_SELFDBG_EVENT_NAME &quot;SelfDebugging&quot;
#define _CRT_SECURE_NO_WARNINGS
#include&lt;windows.h&gt;
#include&lt;stdio.h&gt;

DWORD IsHooked()
{
    DWORD bFirstResult = 0, bSecondResult = 0;
    __try
    {
        bFirstResult = BlockInput(TRUE);
        bSecondResult = BlockInput(TRUE);
    }
    __finally
    {
        BlockInput(0);
    }
    return bFirstResult &amp;&amp; bSecondResult;
}

int main(int argc, char** argv)
{

    if (IsHooked())
        printf(&quot;Find You\n&quot;);
    else
        printf(&quot;where are you\n&quot;);
    return 0;
}</code></pre>
<h1 id="故意触发错误非异常">故意触发错误(非异常)</h1>
<p>win32 编程</p>
<p>A P I</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>CloseHandle<span class="op">((</span>HANDLE<span class="op">)</span><span class="bn">0xBAAD</span><span class="op">);</span> <span class="co">//引起异常</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>LoadLibiary<span class="op">(</span><span class="st">&quot;O(∩_∩)O&quot;</span><span class="op">);</span><span class="co">//返回值确定</span></span></code></pre></div>
<p>CloseHandl会触发异常的(算是中级或者高级的异常)</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;string.h&gt;</span></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdlib.h&gt;</span></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;windows.h&gt;</span></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>EXCEPTION_DISPOSITION ExceptionRoutine<span class="op">(</span></span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>    PEXCEPTION_RECORD ExceptionRecord<span class="op">,</span></span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>    PVOID             EstablisherFrame<span class="op">,</span></span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>    PCONTEXT          ContextRecord<span class="op">,</span></span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>    PVOID             DispatcherContext<span class="op">)</span></span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>EXCEPTION_INVALID_HANDLE <span class="op">==</span> ExceptionRecord<span class="op">-&gt;</span>ExceptionCode<span class="op">)</span></span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a>        printf<span class="op">(</span><span class="st">&quot;Stop debugging program!</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">);</span></span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-16"><a href="#cb21-16" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb21-17"><a href="#cb21-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> ExceptionContinueExecution<span class="op">;</span></span>
<span id="cb21-18"><a href="#cb21-18" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb21-19"><a href="#cb21-19" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">()</span></span>
<span id="cb21-20"><a href="#cb21-20" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb21-21"><a href="#cb21-21" aria-hidden="true" tabindex="-1"></a>    __asm</span>
<span id="cb21-22"><a href="#cb21-22" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb21-23"><a href="#cb21-23" aria-hidden="true" tabindex="-1"></a>        <span class="co">// set SEH handler</span></span>
<span id="cb21-24"><a href="#cb21-24" aria-hidden="true" tabindex="-1"></a>        push ExceptionRoutine</span>
<span id="cb21-25"><a href="#cb21-25" aria-hidden="true" tabindex="-1"></a>        push dword ptr fs <span class="op">:</span> <span class="op">[</span><span class="dv">0</span><span class="op">]</span></span>
<span id="cb21-26"><a href="#cb21-26" aria-hidden="true" tabindex="-1"></a>        mov  dword ptr fs <span class="op">:</span> <span class="op">[</span><span class="dv">0</span><span class="op">]</span> <span class="op">,</span> esp</span>
<span id="cb21-27"><a href="#cb21-27" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb21-28"><a href="#cb21-28" aria-hidden="true" tabindex="-1"></a>    CloseHandle<span class="op">((</span>HANDLE<span class="op">)</span><span class="bn">0xBAAD</span><span class="op">);</span></span>
<span id="cb21-29"><a href="#cb21-29" aria-hidden="true" tabindex="-1"></a>    __asm</span>
<span id="cb21-30"><a href="#cb21-30" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb21-31"><a href="#cb21-31" aria-hidden="true" tabindex="-1"></a>        <span class="co">// return original SEH handler</span></span>
<span id="cb21-32"><a href="#cb21-32" aria-hidden="true" tabindex="-1"></a>        mov  eax<span class="op">,</span> <span class="op">[</span>esp<span class="op">]</span></span>
<span id="cb21-33"><a href="#cb21-33" aria-hidden="true" tabindex="-1"></a>        mov  dword ptr fs <span class="op">:</span> <span class="op">[</span><span class="dv">0</span><span class="op">]</span> <span class="op">,</span> eax</span>
<span id="cb21-34"><a href="#cb21-34" aria-hidden="true" tabindex="-1"></a>        add  esp<span class="op">,</span> <span class="dv">8</span></span>
<span id="cb21-35"><a href="#cb21-35" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb21-36"><a href="#cb21-36" aria-hidden="true" tabindex="-1"></a>    puts<span class="op">(</span><span class="st">&quot;Where are you?</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">);</span></span>
<span id="cb21-37"><a href="#cb21-37" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb21-38"><a href="#cb21-38" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
            </div>
    </div>
  </div>
  <script src="https://vjs.zencdn.net/5.4.4/video.js"></script>

</body>
</html>
